<div class="language-selector">
  <span class="current-lang">
    <i class="fas fa-globe"></i>
    {% if page.lang == 'en' %}
      English
    {% elsif page.lang == 'it' %}
      Italiano
    {% else %}
      {{ page.lang | upcase }}
    {% endif %}
  </span>
  <div class="language-dropdown">
    {% assign pages = site.pages | where:"layout", page.layout | where:"name", page.name %}
    {% assign chapters = site.chapters %}
    
    {% if page.collection == "chapters" %}
      {% assign en_path = page.path | replace_first: page.lang, "en" %}
      {% assign it_path = page.path | replace_first: page.lang, "it" %}
      
      {% assign en_chapter = site.chapters | where:"path", en_path | first %}
      {% assign it_chapter = site.chapters | where:"path", it_path | first %}
      
      {% if en_chapter %}
        <a href="{{ en_chapter.url | relative_url }}" {% if page.lang == 'en' %}class="active"{% endif %}>English</a>
      {% else %}
        <a href="{{ site.baseurl }}/chapters/en/index/" {% if page.lang == 'en' %}class="active"{% endif %}>English</a>
      {% endif %}
      
      {% if it_chapter %}
        <a href="{{ it_chapter.url | relative_url }}" {% if page.lang == 'it' %}class="active"{% endif %}>Italiano</a>
      {% else %}
        <a href="{{ site.baseurl }}/chapters/it/index/" {% if page.lang == 'it' %}class="active"{% endif %}>Italiano</a>
      {% endif %}
    {% else %}
      {% if page.name == "index.md" %}
        <a href="{{ site.baseurl }}/" {% if page.lang == 'en' %}class="active"{% endif %}>English</a>
        <a href="{{ site.baseurl }}/it/" {% if page.lang == 'it' %}class="active"{% endif %}>Italiano</a>
      {% else %}
        <a href="{{ site.baseurl }}/chapters/en/index/" {% if page.lang == 'en' %}class="active"{% endif %}>English</a>
        <a href="{{ site.baseurl }}/chapters/it/index/" {% if page.lang == 'it' %}class="active"{% endif %}>Italiano</a>
      {% endif %}
    {% endif %}
  </div>
</div>
